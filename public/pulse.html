<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Pulse (V91 Debug)</title>
    <link rel="icon" type="image/png" href="iwd-logo-new.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { astro: { 900: '#0b0f19', 800: '#111827' } }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        *, ::before, ::after { animation: none !important; transition: none !important; }
        
        /* HARDCODED COLORS - NO DARK MODE MAGIC */
        .light-card { background: white; border: 1px solid #e5e7eb; color: #111827; }
        .dark-card { background: #111827; border: 1px solid #1f2937; color: white; }
        
        .light-bg { background: #f9fafb; }
        .dark-bg { background: #000000; }
    </style>
</head>
<body class="light-bg min-h-screen p-4 md:p-8 transition-colors duration-200" id="body">

    <!-- STATUS BAR -->
    <div id="status-bar" class="fixed top-0 left-0 right-0 bg-blue-600 text-white text-xs font-bold text-center py-1 z-50">
        Connecting to V91 API...
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="max-w-6xl mx-auto pt-6">
        <!-- HEADER -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div>
                <div class="flex items-center gap-3">
                    <img src="iwd-logo-new.png" class="w-8 h-8 object-contain">
                    <h1 class="text-2xl font-bold" id="title-text">Weekly Pulse <span class="text-xs font-normal opacity-50">v91 (Debug)</span></h1>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="toggleTheme()" class="text-lg p-2 rounded hover:opacity-80 bg-gray-200 dark:bg-gray-800">
                    <span>üåó Theme</span>
                </button>
            </div>
        </div>

        <!-- TOP ROW -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="card p-6 rounded-xl shadow-sm flex flex-col justify-between h-full">
                <h3 class="text-[10px] font-bold uppercase tracking-wider mb-1 text-blue-600">Monthly Projection</h3>
                <div class="text-3xl font-black text-blue-800" id="month-proj">--</div>
                <div class="text-xs mt-1 opacity-60" id="month-rev">Current: --</div>
            </div>
            
            <div class="card p-6 rounded-xl shadow-sm flex flex-col justify-between h-full">
                <h3 class="text-[10px] font-bold uppercase tracking-wider mb-1 text-purple-600">Weekly Goal</h3>
                <input type="number" id="goal-input" value="200" class="bg-transparent text-4xl font-black w-24 border-b border-gray-300 focus:outline-none">
                <div class="text-xs mt-2 font-bold" id="week-pace">Pace: --%</div>
            </div>
            
            <div class="card p-6 rounded-xl shadow-sm flex flex-col justify-between h-full">
                <h3 class="text-[10px] font-bold uppercase tracking-wider mb-1 opacity-60">Month Total</h3>
                <div class="text-3xl font-black" id="month-total-main">--</div>
                <div class="text-xs mt-1 opacity-60" id="month-pct">100% Billable</div>
            </div>
        </div>

        <!-- WEEKLY ROW -->
        <div class="card rounded-lg shadow-sm mb-8 overflow-hidden">
            <div class="px-6 py-3 border-b flex justify-between bg-opacity-50">
                <h3 class="font-bold text-sm">üìÖ Weekly Comparison</h3>
                <span class="text-xs font-mono opacity-50" id="week-range"></span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 divide-y md:divide-y-0 md:divide-x">
                <div class="p-8 text-center bg-blue-50 bg-opacity-20">
                    <div class="text-xs font-bold uppercase mb-6 inline-block px-3 py-1 rounded-full border text-blue-600 border-blue-200 bg-white">This Week</div>
                    <div class="grid grid-cols-2 gap-8">
                        <div>
                            <div class="text-4xl font-black mb-1" id="week-billable">--</div>
                            <div class="text-[10px] uppercase font-bold opacity-50">Billable</div>
                        </div>
                        <div>
                            <div class="text-4xl font-bold mb-1 opacity-60" id="week-pct">--%</div>
                            <div class="text-[10px] uppercase font-bold opacity-50">% Billable</div>
                        </div>
                    </div>
                </div>
                <div class="p-8 text-center">
                    <div class="text-xs font-bold uppercase mb-6 inline-block px-3 py-1 opacity-50">Last Week</div>
                    <div class="grid grid-cols-2 gap-8 opacity-60">
                        <div>
                            <div class="text-3xl font-bold mb-1" id="last-billable">--</div>
                            <div class="text-[10px] uppercase font-bold opacity-50">Billable</div>
                        </div>
                        <div>
                            <div class="text-3xl font-bold mb-1 opacity-60" id="last-pct">--%</div>
                            <div class="text-[10px] uppercase font-bold opacity-50">% Billable</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- LISTS -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="card rounded-lg shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b bg-opacity-50"><h3 class="text-xs font-bold uppercase tracking-wider opacity-60">üèÜ Top Contributors (Billable)</h3></div>
                <table class="w-full text-sm"><tbody class="divide-y" id="top-users"></tbody></table>
            </div>
            <div class="card rounded-lg shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b bg-opacity-50"><h3 class="text-xs font-bold uppercase tracking-wider opacity-60">üíº Top Clients (Total)</h3></div>
                <table class="w-full text-sm"><tbody class="divide-y" id="top-clients"></tbody></table>
            </div>
        </div>
        
        <!-- DEBUG FOOTER -->
        <div class="mt-8 p-4 bg-gray-900 text-green-400 font-mono text-[10px] rounded overflow-x-auto">
            <strong>Debug Info:</strong>
            <pre id="debug-pre">Waiting...</pre>
        </div>
    </div>

    <script>
        const API_URL = '/.netlify/functions/get-stats?v=' + Date.now(); 

        let isDark = true; 

        function toggleTheme() {
            isDark = !isDark;
            applyTheme();
        }

        function applyTheme() {
            const body = document.getElementById('body');
            const cards = document.querySelectorAll('.card');
            
            if (isDark) {
                body.className = "bg-black text-white min-h-screen p-4 md:p-8 transition-colors duration-200";
                cards.forEach(c => c.className = c.className.replace('light-card', 'dark-card').replace('bg-white', '').replace('bg-gray-900', '') + ' dark-card');
                document.querySelectorAll('.divide-y').forEach(el => el.classList.add('divide-gray-800'));
                document.querySelectorAll('.border-b').forEach(el => el.classList.add('border-gray-800'));
            } else {
                body.className = "bg-gray-50 text-gray-900 min-h-screen p-4 md:p-8 transition-colors duration-200";
                cards.forEach(c => c.className = c.className.replace('dark-card', 'light-card').replace('bg-white', '').replace('bg-gray-900', '') + ' light-card');
                document.querySelectorAll('.divide-y').forEach(el => el.classList.remove('divide-gray-800'));
                document.querySelectorAll('.border-b').forEach(el => el.classList.remove('border-gray-800'));
            }
        }

        setTimeout(() => { isDark = true; applyTheme(); }, 100);

        window.addEventListener('DOMContentLoaded', init);

        async function init() {
            const status = document.getElementById('status-bar');
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                
                // Debug Output
                const debugInfo = {
                    entries: data.meta.debug.entriesProcessed,
                    thisWeekStart: data.meta.debug.thisWeekStart,
                    lastWeekStart: data.meta.debug.lastWeekStart,
                    monthStart: data.meta.debug.monthStartStr,
                    sample: data.meta.debug.sampleEntries
                };
                document.getElementById('debug-pre').innerText = JSON.stringify(debugInfo, null, 2);
                
                status.innerText = "Loaded (" + debugInfo.entries + " entries)";
                status.className = "fixed top-0 left-0 right-0 bg-green-600 text-white text-xs font-bold text-center py-1 z-50";
                setTimeout(() => status.classList.add('hidden'), 3000);
                
                render(data);
            } catch (e) {
                console.error(e);
                status.innerText = "Error: " + e.message;
                status.className = "fixed top-0 left-0 right-0 bg-red-600 text-white text-xs font-bold text-center py-1 z-50";
            }
        }

        function render(data) {
            const p = data.pulse;
            const users = data.users || [];
            const projects = data.projects || [];

            const totalRev = projects.reduce((s, x) => s + (x.hours * (x.rate || 155)), 0);
            
            const now = new Date();
            const start = new Date(now.getFullYear(), now.getMonth(), 1);
            let daysPassed = 0;
            let cur = new Date(start);
            while(cur <= now) {
                if(cur.getDay()!==0 && cur.getDay()!==6) daysPassed++;
                cur.setDate(cur.getDate()+1);
            }
            if (now.getHours() < 17) daysPassed = Math.max(daysPassed - 1, 1);
            const totalDays = 20; 
            const projRev = (totalRev / daysPassed) * totalDays;

            document.getElementById('month-rev').innerText = '$' + Math.round(totalRev).toLocaleString();
            document.getElementById('month-proj').innerText = '$' + Math.round(projRev).toLocaleString();
            document.getElementById('month-total-main').innerText = Math.round(p.month.t) + 'h';

            document.getElementById('week-billable').innerText = Math.round(p.thisWeek.b);
            const wPct = p.thisWeek.t > 0 ? Math.round((p.thisWeek.b / p.thisWeek.t) * 100) : 0;
            document.getElementById('week-pct').innerText = wPct + '%';

            document.getElementById('last-billable').innerText = Math.round(p.lastWeek.b);
            const lPct = p.lastWeek.t > 0 ? Math.round((p.lastWeek.b / p.lastWeek.t) * 100) : 0;
            document.getElementById('last-pct').innerText = lPct + '%';

            const updatePace = () => {
                const goal = parseFloat(document.getElementById('goal-input').value) || 200;
                const billable = p.thisWeek.b || 0;
                const pace = Math.round((billable / goal) * 100);
                const el = document.getElementById('week-pace');
                el.innerText = `Pace: ${pace}%`;
                if (pace >= 100) el.style.color = "#10b981"; 
                else if (pace >= 80) el.style.color = "#d97706"; 
                else el.style.color = "inherit";
            };
            updatePace();
            document.getElementById('goal-input').addEventListener('input', updatePace);

            const renderList = (id, list) => {
                const el = document.getElementById(id);
                el.innerHTML = '';
                list.sort((a,b) => (b.hours || 0) - (a.hours || 0)).slice(0,5).forEach((item, i) => {
                    el.innerHTML += `
                        <tr class="hover:bg-white hover:bg-opacity-10 border-b border-gray-200 dark:border-gray-800">
                            <td class="px-6 py-3 w-10 text-xs font-mono opacity-50">0${i+1}</td>
                            <td class="px-6 py-3 font-medium">${item.name}</td>
                            <td class="px-6 py-3 text-right font-mono opacity-80">${Math.round(item.hours)}h</td>
                        </tr>`;
                });
            };
            renderList('top-users', users);
            renderList('top-clients', projects);
        }
    </script>
</body>
</html>