<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Pulse (V110)</title>
    <link rel="icon" type="image/png" href="iwd-logo-new.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { astro: { 900: '#0b0f19', 800: '#111827' } }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        *, ::before, ::after { animation: none !important; transition: none !important; }
        
        .light-card { background: white; border: 1px solid #e5e7eb; color: #111827; }
        .dark-card { background: #111827; border: 1px solid #1f2937; color: white; }
        .light-bg { background: #f9fafb; }
        .dark-bg { background: #000000; }
        
        .flex-center-col { display: flex; flex-direction: column; justify-content: center; align-items: center; }
    </style>
</head>
<body class="light-bg min-h-screen p-4 md:p-8 transition-colors duration-200" id="body">

    <!-- STATUS BAR -->
    <div id="status-bar" class="fixed top-0 left-0 right-0 bg-blue-600 text-white text-xs font-bold text-center py-1 z-50">
        Syncing V110...
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="max-w-6xl mx-auto pt-6">
        
        <!-- HEADER -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div>
                <div class="flex items-center gap-3">
                    <img src="iwd-logo-new.png" class="w-8 h-8 object-contain">
                    <h1 class="text-2xl font-bold tracking-tight">Weekly Pulse <span class="text-xs font-normal opacity-50 ml-1">v110</span></h1>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="toggleTheme()" class="text-2xl p-2 hover:opacity-80 transition-opacity" title="Toggle Theme">
                    <span id="theme-icon">‚òÄÔ∏è</span>
                </button>
            </div>
        </div>

        <!-- TOP ROW -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="card p-6 rounded-xl shadow-sm flex flex-col justify-between h-full border-l-4 border-green-500">
                <h3 class="text-[10px] font-bold uppercase tracking-wider mb-1 text-green-600">Monthly Projection</h3>
                <div class="text-3xl font-black text-green-600 dark:text-green-400" id="month-proj">--</div>
                <div class="text-xs mt-1 opacity-60" id="month-rev">Current: --</div>
            </div>
            
            <div class="card p-6 rounded-xl shadow-sm flex flex-col justify-between h-full">
                <h3 class="text-[10px] font-bold uppercase tracking-wider mb-1 text-purple-600">Weekly Goal</h3>
                <div class="flex items-baseline gap-2">
                    <input type="number" id="goal-input" value="200" class="bg-transparent text-4xl font-black w-24 border-b border-gray-300 dark:border-gray-700 focus:outline-none">
                </div>
                <div class="text-xs mt-2 font-bold" id="week-pace">Pace: --%</div>
            </div>
            
            <div class="card p-6 rounded-xl shadow-sm flex flex-col justify-between h-full">
                <h3 class="text-[10px] font-bold uppercase tracking-wider mb-1 opacity-60">Month Total</h3>
                <div class="text-3xl font-black" id="month-total-main">--</div>
                <div class="text-xs mt-1 opacity-60" id="month-pct">100% Billable</div>
            </div>
        </div>

        <!-- WEEKLY ROW -->
        <div class="card rounded-lg shadow-sm mb-8 overflow-hidden">
            <div class="px-6 py-3 border-b flex justify-between items-center bg-opacity-50">
                <h3 class="font-bold text-sm">üìÖ Weekly Comparison</h3>
                <span class="text-xs font-mono opacity-50" id="week-range"></span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 divide-y md:divide-y-0 md:divide-x">
                <!-- This Week (Fixed BG) -->
                <div class="p-8 text-center bg-gray-100 dark:bg-[#111827] flex flex-col justify-center items-center border-r border-gray-200 dark:border-gray-800">
                    <div class="text-xs font-bold uppercase mb-6 inline-block px-3 py-1 rounded-full border text-blue-600 border-blue-200 bg-white dark:bg-black dark:border-blue-900 dark:text-blue-400">This Week</div>
                    <div class="grid grid-cols-2 gap-8 w-full max-w-xs">
                        <div class="text-center">
                            <div class="text-4xl font-black mb-1 text-gray-900 dark:text-white" id="week-billable">--</div>
                            <div class="text-[10px] uppercase font-bold opacity-50 text-gray-600 dark:text-gray-400">Billable</div>
                        </div>
                        <div class="text-center">
                            <div class="text-4xl font-bold mb-1 opacity-60 text-gray-900 dark:text-gray-300" id="week-pct">--%</div>
                            <div class="text-[10px] uppercase font-bold opacity-50 text-gray-600 dark:text-gray-400">% Billable</div>
                        </div>
                    </div>
                </div>
                <!-- Last Week -->
                <div class="p-8 text-center flex flex-col justify-center items-center">
                    <div class="text-xs font-bold uppercase mb-6 inline-block px-3 py-1 opacity-50">Last Week</div>
                    <div class="grid grid-cols-2 gap-8 w-full max-w-xs opacity-60">
                        <div class="text-center">
                            <div class="text-3xl font-bold mb-1" id="last-billable">--</div>
                            <div class="text-[10px] uppercase font-bold opacity-50">Billable</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold mb-1 opacity-60" id="last-pct">--%</div>
                            <div class="text-[10px] uppercase font-bold opacity-50">% Billable</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- LISTS -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="card rounded-lg shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b bg-opacity-50"><h3 class="text-xs font-bold uppercase tracking-wider opacity-60">üèÜ Top Contributors (Billable)</h3></div>
                <table class="w-full text-sm"><tbody class="divide-y" id="top-users"></tbody></table>
            </div>
            <div class="card rounded-lg shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b bg-opacity-50"><h3 class="text-xs font-bold uppercase tracking-wider opacity-60">üíº Top Clients (Total)</h3></div>
                <table class="w-full text-sm"><tbody class="divide-y" id="top-clients"></tbody></table>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/.netlify/functions/get-pulse?v=' + Date.now(); 
        
        function log(msg) { console.log(msg); } 

        let isDark = true; 

        function toggleTheme() {
            isDark = !isDark;
            applyTheme();
            document.getElementById('theme-icon').innerText = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        function applyTheme() {
            const body = document.getElementById('body');
            const cards = document.querySelectorAll('.card');
            
            if (isDark) {
                body.className = "bg-black text-white min-h-screen p-4 md:p-8 transition-colors duration-200";
                cards.forEach(c => c.className = c.className.replace('light-card', 'dark-card').replace('bg-white', '').replace('bg-gray-900', '') + ' dark-card');
                document.querySelectorAll('.divide-y').forEach(el => el.classList.add('divide-gray-800'));
                document.querySelectorAll('.border-b').forEach(el => el.classList.add('border-gray-800'));
                document.querySelectorAll('.border-r').forEach(el => el.classList.add('border-gray-800'));
            } else {
                body.className = "bg-gray-50 text-gray-900 min-h-screen p-4 md:p-8 transition-colors duration-200";
                cards.forEach(c => c.className = c.className.replace('dark-card', 'light-card').replace('bg-white', '').replace('bg-gray-900', '') + ' light-card');
                document.querySelectorAll('.divide-y').forEach(el => el.classList.remove('divide-gray-800'));
                document.querySelectorAll('.border-b').forEach(el => el.classList.remove('border-gray-800'));
                document.querySelectorAll('.border-r').forEach(el => el.classList.remove('border-gray-800'));
            }
        }

        setTimeout(() => { isDark = true; applyTheme(); document.getElementById('theme-icon').innerText = '‚òÄÔ∏è'; }, 100);

        window.addEventListener('DOMContentLoaded', init);

        async function init() {
            const status = document.getElementById('status-bar');
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                
                status.innerText = "Loaded (" + (data.meta ? data.meta.count : 0) + " entries)";
                status.className = "fixed top-0 left-0 right-0 bg-green-600 text-white text-xs font-bold text-center py-1 z-50";
                setTimeout(() => status.classList.add('hidden'), 3000);
                
                processData(data);
            } catch (e) {
                console.error(e);
                status.innerText = "Error: " + e.message;
                status.className = "fixed top-0 left-0 right-0 bg-red-600 text-white text-xs font-bold text-center py-1 z-50";
            }
        }

        function processData(data) {
            const entries = data.entries || [];
            const rates = data.rates || {};
            const globalRate = data.globalRate || 155;

            const now = new Date();
            const toStr = (d) => {
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${y}-${m}-${day}`;
            };

            const d = new Date(now);
            const day = d.getDay(); 
            const diff = d.getDate() - day + (day == 0 ? -6 : 1); 
            
            const thisMon = new Date(d);
            thisMon.setDate(diff);
            const thisSun = new Date(thisMon);
            thisSun.setDate(thisMon.getDate() + 6);
            
            const lastMon = new Date(thisMon);
            lastMon.setDate(thisMon.getDate() - 7);
            const lastSun = new Date(lastMon);
            lastSun.setDate(lastMon.getDate() + 6);
            
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            
            const thisWeekStart = toStr(thisMon);
            const thisWeekEnd = toStr(thisSun);
            const lastWeekStart = toStr(lastMon);
            const lastWeekEnd = toStr(lastSun);
            const monthStartStr = toStr(monthStart);

            let stats = {
                month: { b: 0, t: 0, rev: 0 },
                thisWeek: { b: 0, t: 0, t_adj: 0 }, 
                lastWeek: { b: 0, t: 0, t_adj: 0 }
            };
            
            let users = {};
            let projects = {};

            entries.forEach(e => {
                let dateStr = e.d;
                if (!dateStr.includes('-') && dateStr.length === 8) {
                    dateStr = `${dateStr.slice(0,4)}-${dateStr.slice(4,6)}-${dateStr.slice(6,8)}`;
                }

                // MONTHLY: Strict Filter (Exclude Internal)
                if (dateStr >= monthStartStr) {
                    const isInternal = e.p.match(/IWD|Runners|Dominate/i);
                    
                    if (!isInternal) {
                        stats.month.t += e.h;
                        if (e.b) stats.month.b += e.h;
                        
                        const rate = rates[e.pid] || rates[e.p] || globalRate;
                        stats.month.rev += e.h * rate;

                        if (e.b) {
                            if (!users[e.u]) users[e.u] = 0;
                            users[e.u] += e.h;
                        }
                        if (!projects[e.p]) projects[e.p] = { hours: 0 };
                        projects[e.p].hours += e.h;
                    }
                }

                // WEEKLY: Loose Filter (Include Internal, Exclude Isah)
                if (e.x) return; // SKIP ISAH from Weekly Denominators

                if (dateStr >= thisWeekStart && dateStr <= thisWeekEnd) {
                    stats.thisWeek.t += e.h;
                    if (!e.x) stats.thisWeek.t_adj += e.h; 
                    if (e.b) stats.thisWeek.b += e.h;
                } 
                else if (dateStr >= lastWeekStart && dateStr <= lastWeekEnd) {
                    stats.lastWeek.t += e.h;
                    if (!e.x) stats.lastWeek.t_adj += e.h;
                    if (e.b) stats.lastWeek.b += e.h;
                }
            });

            document.getElementById('week-range').innerText = `${thisWeekStart} -> Now`;
            render(stats, users, projects);
        }

        function render(stats, users, projects) {
            const now = new Date();
            const start = new Date(now.getFullYear(), now.getMonth(), 1);
            let daysPassed = 0;
            let cur = new Date(start);
            while(cur <= now) {
                if(cur.getDay()!==0 && cur.getDay()!==6) daysPassed++;
                cur.setDate(cur.getDate()+1);
            }
            if (now.getHours() < 17) daysPassed = Math.max(daysPassed - 1, 1);
            const totalDays = 20; 
            const projRev = (stats.month.rev / daysPassed) * totalDays;

            document.getElementById('month-rev').innerText = '$' + Math.round(stats.month.rev).toLocaleString();
            document.getElementById('month-proj').innerText = '$' + Math.round(projRev).toLocaleString();
            document.getElementById('month-total-main').innerText = Math.round(stats.month.t) + 'h';

            // Weekly
            document.getElementById('week-billable').innerText = Math.round(stats.thisWeek.b);
            const wPct = stats.thisWeek.t_adj > 0 ? Math.round((stats.thisWeek.b / stats.thisWeek.t_adj) * 100) : 0;
            document.getElementById('week-pct').innerText = wPct + '%';

            document.getElementById('last-billable').innerText = Math.round(stats.lastWeek.b);
            const lPct = stats.lastWeek.t_adj > 0 ? Math.round((stats.lastWeek.b / stats.lastWeek.t_adj) * 100) : 0;
            document.getElementById('last-pct').innerText = lPct + '%';

            const updatePace = () => {
                const goal = parseFloat(document.getElementById('goal-input').value) || 200;
                const billable = stats.thisWeek.b || 0;
                const pace = Math.round((billable / goal) * 100);
                const el = document.getElementById('week-pace');
                el.innerText = `Pace: ${pace}%`;
                if (pace >= 100) el.style.color = "#10b981"; 
                else if (pace >= 80) el.style.color = "#d97706"; 
                else el.style.color = "inherit";
            };
            updatePace();
            document.getElementById('goal-input').addEventListener('input', updatePace);

            const renderList = (id, listObj) => {
                const el = document.getElementById(id);
                el.innerHTML = '';
                const sorted = Object.keys(listObj).map(k => ({ name: k, hours: listObj[k].hours || listObj[k] }));
                sorted.sort((a,b) => b.hours - a.hours).slice(0,5).forEach((item, i) => {
                    el.innerHTML += `
                        <tr class="hover:bg-white hover:bg-opacity-10 dark:border-gray-800">
                            <td class="px-6 py-3 w-10 text-xs font-mono opacity-50">0${i+1}</td>
                            <td class="px-6 py-3 font-medium">${item.name}</td>
                            <td class="px-6 py-3 text-right font-mono opacity-80">${Math.round(item.hours)}h</td>
                        </tr>`;
                });
            };
            renderList('top-users', users);
            renderList('top-clients', projects);
        }
    </script>
</body>
</html>