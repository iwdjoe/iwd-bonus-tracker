<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Pulse (V139 Bulletproof)</title>
    <link rel="icon" type="image/png" href="iwd-logo-new.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { astro: { 900: '#0b0f19', 800: '#111827' } }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        *, ::before, ::after { animation: none !important; transition: none !important; }
        
        .light-card { background: white; border: 1px solid #e5e7eb; color: #111827; }
        .dark-card { background: #111827; border: 1px solid #1f2937; color: white; }
        .light-bg { background: #f9fafb; }
        .dark-bg { background: #000000; }
        
        #error-box {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #dc2626;
            color: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            z-index: 9999;
            max-width: 90%;
            width: 500px;
            border: 3px solid #fca5a5;
        }
        #error-box.visible { display: block; }
        #error-box pre {
            background: rgba(0,0,0,0.3);
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 11px;
            margin-top: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="light-bg min-h-screen p-4 md:p-8 transition-colors duration-200" id="body">

    <!-- GLOBAL ERROR BOX -->
    <div id="error-box">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
            <h2 style="font-weight: bold; font-size: 18px;">üö® ERROR DETECTED</h2>
            <button onclick="document.getElementById('error-box').classList.remove('visible')" style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 6px; font-weight: bold;">CLOSE</button>
        </div>
        <p id="error-message" style="margin-bottom: 8px; font-size: 14px;"></p>
        <pre id="error-details" style="font-family: monospace; white-space: pre-wrap; word-break: break-all;"></pre>
        <p style="margin-top: 12px; font-size: 12px; opacity: 0.8;">üì∏ Screenshot this and send to dev team</p>
    </div>

    <!-- STATUS BAR -->
    <div id="status-bar" class="fixed top-0 left-0 right-0 bg-blue-600 text-white text-xs font-bold text-center py-1 z-50">
        Initializing...
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="max-w-6xl mx-auto pt-6">
        
        <!-- HEADER -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div>
                <div class="flex items-center gap-3">
                    <img src="iwd-logo-new.png" class="w-8 h-8 object-contain">
                    <h1 class="text-2xl font-bold tracking-tight">Weekly Pulse <span class="text-xs font-normal opacity-50 ml-1">V139</span></h1>
                    <span class="text-[10px] font-bold bg-green-100 text-green-800 px-2 py-0.5 rounded-full uppercase">BULLETPROOF</span>
                </div>
                <div class="text-xs opacity-50 mt-1 ml-11 flex gap-4">
                    <span>Last Updated: <span id="time-updated">--</span></span>
                    <span id="user-email" class="hidden md:inline">--</span>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <button onclick="toggleTheme()" class="text-xl p-2 rounded hover:opacity-80 transition-opacity" title="Toggle Theme">
                    <span id="theme-icon">‚òÄÔ∏è</span>
                </button>
                <button onclick="netlifyIdentity.logout()" class="text-xl p-2 rounded hover:opacity-80 transition-opacity text-gray-500 hover:text-red-500" title="Logout">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                </button>
            </div>
        </div>

        <!-- TOP ROW -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="card p-6 rounded-xl shadow-sm flex flex-col justify-between h-full border-l-4 border-green-500">
                <h3 class="text-[10px] font-bold uppercase tracking-wider mb-1 text-green-600">Monthly Projection</h3>
                <div class="text-3xl font-black text-green-600 dark:text-green-400" id="month-proj">--</div>
                <div class="text-xs mt-1 opacity-60" id="month-rev">Current: --</div>
            </div>
            
            <div class="card p-6 rounded-xl shadow-sm flex flex-col justify-between h-full">
                <h3 class="text-[10px] font-bold uppercase tracking-wider mb-1 text-purple-600">Weekly Goal</h3>
                <div class="flex items-baseline gap-2">
                    <input type="number" id="goal-input" value="200" class="bg-transparent text-4xl font-black w-24 border-b border-gray-300 dark:border-gray-700 focus:outline-none">
                </div>
                <div class="text-xs mt-2 font-bold" id="week-pace">Pace: --%</div>
            </div>
            
            <div class="card p-6 rounded-xl shadow-sm flex flex-col justify-between h-full">
                <h3 class="text-[10px] font-bold uppercase tracking-wider mb-1 opacity-60">Month Total</h3>
                <div class="text-3xl font-black" id="month-total-main">--</div>
                <div class="text-xs mt-1 opacity-60" id="month-pct">100% Billable</div>
            </div>
        </div>

        <!-- WEEKLY ROW -->
        <div class="card rounded-lg shadow-sm mb-8 overflow-hidden">
            <div class="px-6 py-3 border-b flex justify-between items-center bg-green-600 bg-opacity-10">
                <h3 class="font-bold text-sm text-green-600 dark:text-green-400">üìÖ Weekly Comparison</h3>
                <span class="text-xs font-mono opacity-50" id="week-range">--</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 divide-y md:divide-y-0 md:divide-x">
                
                <!-- This Week -->
                <div id="this-week-box" class="p-8 text-center flex flex-col justify-center items-center border-r border-gray-200 dark:border-gray-800 transition-colors duration-200">
                    <div class="text-xs font-bold uppercase mb-6 inline-block px-3 py-1 rounded-full border text-blue-600 border-blue-200 bg-white dark:bg-black dark:border-blue-900 dark:text-blue-400">This Week</div>
                    
                    <div class="text-[10px] opacity-50 mb-6 font-mono" id="this-week-dates">--</div>
                    <div class="grid grid-cols-2 gap-8 w-full max-w-xs">
                        <div class="text-center">
                            <div class="text-4xl font-black mb-1 text-gray-900 dark:text-white" id="week-billable">--</div>
                            <div class="text-[10px] uppercase font-bold opacity-50 text-gray-600 dark:text-gray-400">Billable</div>
                        </div>
                        <div class="text-center">
                            <div class="text-4xl font-bold mb-1 opacity-60 text-gray-900 dark:text-gray-300" id="week-pct">--%</div>
                            <div class="text-[10px] uppercase font-bold opacity-50 text-gray-600 dark:text-gray-400">% Billable</div>
                        </div>
                    </div>
                </div>
                
                <!-- Last Week -->
                <div class="p-8 text-center flex flex-col justify-center items-center">
                    <div class="text-xs font-bold uppercase mb-2 inline-block px-3 py-1 opacity-50">Last Week</div>
                    <div class="text-[10px] opacity-50 mb-6 font-mono" id="last-week-dates">--</div>
                    
                    <div class="grid grid-cols-2 gap-8 w-full max-w-xs opacity-60">
                        <div class="text-center">
                            <div class="text-3xl font-bold mb-1" id="last-billable">--</div>
                            <div class="text-[10px] uppercase font-bold opacity-50">Billable</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold mb-1 opacity-60" id="last-pct">--%</div>
                            <div class="text-[10px] uppercase font-bold opacity-50">% Billable</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- LISTS -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="card rounded-lg shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b bg-green-600 bg-opacity-10"><h3 class="text-xs font-bold uppercase tracking-wider text-green-600 dark:text-green-400">üèÜ Top Contributors (Billable)</h3></div>
                <table class="w-full text-sm"><tbody class="divide-y" id="top-users"></tbody></table>
            </div>
            <div class="card rounded-lg shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b bg-green-600 bg-opacity-10"><h3 class="text-xs font-bold uppercase tracking-wider text-green-600 dark:text-green-400">üíº Top Clients (Total)</h3></div>
                <table class="w-full text-sm"><tbody class="divide-y" id="top-clients"></tbody></table>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // BULLETPROOF V139 - DEFENSIVE CODING EDITION
        // ============================================
        
        const API_URL = '/.netlify/functions/get-pulse?v=' + Date.now(); 
        
        // GLOBAL ERROR HANDLER
        window.onerror = function(message, source, lineno, colno, error) {
            showError('JavaScript Error', `${message}\n\nFile: ${source}\nLine: ${lineno}:${colno}\n\n${error ? error.stack : 'No stack trace'}`);
            return true; // Prevent default browser error handling
        };

        window.addEventListener('unhandledrejection', function(event) {
            showError('Unhandled Promise Rejection', event.reason ? (event.reason.stack || event.reason.toString()) : 'Unknown error');
        });

        function showError(title, details) {
            console.error('[ERROR]', title, details);
            const box = document.getElementById('error-box');
            const msg = document.getElementById('error-message');
            const det = document.getElementById('error-details');
            
            if (box && msg && det) {
                msg.textContent = title;
                det.textContent = details;
                box.classList.add('visible');
            }
            
            // Also update status bar
            const status = document.getElementById('status-bar');
            if (status) {
                status.innerText = "‚ùå ERROR: " + title;
                status.className = "fixed top-0 left-0 right-0 bg-red-600 text-white text-xs font-bold text-center py-1 z-50";
            }
        }

        function safeGetElement(id, defaultValue = '--') {
            try {
                const el = document.getElementById(id);
                if (!el) {
                    console.warn(`Element not found: ${id}`);
                    return null;
                }
                return el;
            } catch (e) {
                console.error(`Error getting element ${id}:`, e);
                return null;
            }
        }

        function safeSetText(id, value) {
            const el = safeGetElement(id);
            if (el) el.innerText = value || '--';
        }

        function safeSetHTML(id, value) {
            const el = safeGetElement(id);
            if (el) el.innerHTML = value || '';
        }

        // NETLIFY IDENTITY
        try {
            netlifyIdentity.on('init', user => { 
                if (user && user.email) {
                    safeSetText('user-email', user.email);
                }
            });
            netlifyIdentity.on('login', () => { 
                netlifyIdentity.close(); 
                location.reload(); 
            });
            netlifyIdentity.on('logout', () => { 
                location.reload(); 
            });
            netlifyIdentity.init();
        } catch (e) {
            console.error('Netlify Identity error:', e);
            showError('Auth System Error', e.toString());
        }

        let isDark = true; 

        function toggleTheme() {
            try {
                isDark = !isDark;
                applyTheme();
                safeSetText('theme-icon', isDark ? '‚òÄÔ∏è' : 'üåô');
            } catch (e) {
                showError('Theme Toggle Error', e.toString());
            }
        }

        function applyTheme() {
            try {
                const body = safeGetElement('body');
                const cards = document.querySelectorAll('.card');
                const thisWeekBox = safeGetElement('this-week-box');
                
                if (!body) return;
                
                if (isDark) {
                    body.className = "bg-black text-white min-h-screen p-4 md:p-8 transition-colors duration-200";
                    cards.forEach(c => {
                        if (c) c.className = c.className.replace('light-card', 'dark-card').replace('bg-white', '').replace('bg-gray-900', '') + ' dark-card';
                    });
                    
                    if (thisWeekBox) thisWeekBox.className = "p-8 text-center flex flex-col justify-center items-center border-r border-gray-800 transition-colors duration-200 bg-blue-900 bg-opacity-10 text-white";
                    
                    const weekBillable = safeGetElement('week-billable');
                    if (weekBillable) weekBillable.className = "text-4xl font-black mb-1 text-white";
                    
                    document.querySelectorAll('.divide-y').forEach(el => el.classList.add('divide-gray-800'));
                    document.querySelectorAll('.border-b').forEach(el => el.classList.add('border-gray-800'));
                } else {
                    body.className = "bg-gray-50 text-gray-900 min-h-screen p-4 md:p-8 transition-colors duration-200";
                    cards.forEach(c => {
                        if (c) c.className = c.className.replace('dark-card', 'light-card').replace('bg-white', '').replace('bg-gray-900', '') + ' light-card';
                    });
                    
                    if (thisWeekBox) thisWeekBox.className = "p-8 text-center flex flex-col justify-center items-center border-r border-gray-200 transition-colors duration-200 bg-blue-50 text-gray-900";
                    
                    const weekBillable = safeGetElement('week-billable');
                    if (weekBillable) weekBillable.className = "text-4xl font-black mb-1 text-gray-900";
                    
                    document.querySelectorAll('.divide-y').forEach(el => el.classList.remove('divide-gray-800'));
                    document.querySelectorAll('.border-b').forEach(el => el.classList.remove('border-gray-800'));
                }
            } catch (e) {
                showError('Theme Application Error', e.toString());
            }
        }

        setTimeout(() => { 
            try {
                isDark = true; 
                applyTheme(); 
                safeSetText('theme-icon', '‚òÄÔ∏è');
            } catch (e) {
                showError('Initial Theme Error', e.toString());
            }
        }, 100);

        window.addEventListener('DOMContentLoaded', init);

        async function init() {
            console.log('[INIT] Starting application...');
            const status = safeGetElement('status-bar');
            if (status) status.innerText = "Connecting to API...";
            
            try {
                console.log('[INIT] Fetching from:', API_URL);
                const res = await fetch(API_URL);
                
                console.log('[INIT] Response status:', res.status, res.statusText);
                
                if (!res.ok) {
                    throw new Error(`API returned ${res.status}: ${res.statusText}`);
                }
                
                const rawText = await res.text();
                console.log('[INIT] Raw response (first 500 chars):', rawText.substring(0, 500));
                
                let data;
                try {
                    data = JSON.parse(rawText);
                } catch (parseError) {
                    throw new Error(`JSON Parse Error: ${parseError.message}\n\nResponse: ${rawText.substring(0, 200)}`);
                }
                
                console.log('[INIT] Parsed data:', {
                    hasEntries: !!data.entries,
                    entriesCount: data.entries ? data.entries.length : 0,
                    hasRates: !!data.rates,
                    hasMeta: !!data.meta
                });
                
                if (!data) {
                    throw new Error('API returned null/undefined data');
                }
                
                if (!data.entries) {
                    throw new Error('API response missing "entries" field');
                }
                
                if (!Array.isArray(data.entries)) {
                    throw new Error(`"entries" is not an array, got: ${typeof data.entries}`);
                }
                
                const count = data.entries.length;
                console.log('[INIT] Data loaded successfully. Entry count:', count);
                
                if (status) {
                    status.innerText = `‚úÖ Loaded (${count} entries)`;
                    status.className = "fixed top-0 left-0 right-0 bg-green-600 text-white text-xs font-bold text-center py-1 z-50";
                    setTimeout(() => status.classList.add('hidden'), 3000);
                }
                
                const date = new Date();
                safeSetText('time-updated', date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
                
                processData(data);
                
            } catch (e) {
                console.error('[INIT] Fatal error:', e);
                showError('Failed to Load Data', `${e.message}\n\n${e.stack || 'No stack trace'}`);
                
                if (status) {
                    status.innerText = "‚ùå Failed to load";
                    status.className = "fixed top-0 left-0 right-0 bg-red-600 text-white text-xs font-bold text-center py-1 z-50";
                }
            }
        }

        function processData(data) {
            try {
                console.log('[PROCESS] Starting data processing...');
                
                const entries = data.entries || [];
                const rates = data.rates || {};
                const globalRate = data.globalRate || 155;

                console.log('[PROCESS] Using global rate:', globalRate);
                console.log('[PROCESS] Custom rates count:', Object.keys(rates).length);

                const now = new Date();
                
                // SAFE DATE FORMATTER
                const toStr = (d) => {
                    try {
                        if (!d || !(d instanceof Date) || isNaN(d.getTime())) {
                            console.error('[DATE] Invalid date:', d);
                            return '1970-01-01';
                        }
                        const y = d.getFullYear();
                        const m = String(d.getMonth() + 1).padStart(2, '0');
                        const day = String(d.getDate()).padStart(2, '0');
                        return `${y}-${m}-${day}`;
                    } catch (e) {
                        console.error('[DATE] Format error:', e);
                        return '1970-01-01';
                    }
                };

                // WEEK RANGES
                const d = new Date(now);
                const day = d.getDay(); 
                const diff = d.getDate() - day + (day == 0 ? -6 : 1); 
                
                const thisMon = new Date(d.setDate(diff));
                const thisSun = new Date(thisMon);
                thisSun.setDate(thisMon.getDate() + 6);
                
                const lastMon = new Date(thisMon);
                lastMon.setDate(lastMon.getDate() - 7);
                const lastSun = new Date(lastMon);
                lastSun.setDate(lastMon.getDate() + 6);
                
                const thisWeekStart = toStr(thisMon);
                const thisWeekEnd = toStr(thisSun);
                const lastWeekStart = toStr(lastMon);
                const lastWeekEnd = toStr(lastSun);
                
                console.log('[PROCESS] Week ranges:', {
                    thisWeek: `${thisWeekStart} ‚Üí ${thisWeekEnd}`,
                    lastWeek: `${lastWeekStart} ‚Üí ${lastWeekEnd}`
                });
                
                // MONTH START
                const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                const monthStartStr = toStr(monthStart);

                safeSetText('week-range', `${thisWeekStart} ‚Üí ${thisWeekEnd}`);

                let stats = {
                    month: { b: 0, t: 0, rev: 0 },
                    thisWeek: { b: 0, t: 0, t_adj: 0 }, 
                    lastWeek: { b: 0, t: 0, t_adj: 0 }
                };
                
                let users = {};
                let projects = {};

                console.log('[PROCESS] Processing entries...');
                let processedCount = 0;
                let skippedCount = 0;

                entries.forEach((e, idx) => {
                    try {
                        if (!e || typeof e !== 'object') {
                            console.warn(`[PROCESS] Entry ${idx} is not an object:`, e);
                            skippedCount++;
                            return;
                        }
                        
                        // DEFENSIVE DATE NORMALIZATION
                        let dateStr = e.d || e.date || '';
                        if (!dateStr) {
                            console.warn(`[PROCESS] Entry ${idx} has no date:`, e);
                            skippedCount++;
                            return;
                        }
                        
                        // Convert YYYYMMDD to YYYY-MM-DD
                        if (!dateStr.includes('-') && dateStr.length === 8) {
                            dateStr = `${dateStr.slice(0,4)}-${dateStr.slice(4,6)}-${dateStr.slice(6,8)}`;
                        }
                        
                        // Validate date format
                        if (!/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                            console.warn(`[PROCESS] Entry ${idx} has invalid date format: "${dateStr}"`);
                            skippedCount++;
                            return;
                        }

                        // MONTHLY STATS
                        if (dateStr >= monthStartStr) {
                            if (!e.i) {
                                stats.month.t += (e.h || 0);
                                if (e.b) stats.month.b += (e.h || 0);
                                const rate = rates[e.pid] || rates[e.p] || globalRate;
                                stats.month.rev += (e.h || 0) * rate;
                                
                                if (e.b && !e.x) {
                                    if (!users[e.u]) users[e.u] = 0;
                                    users[e.u] += (e.h || 0);
                                }
                            }
                            
                            if (!e.i) {
                                if (!projects[e.p]) projects[e.p] = { hours: 0 };
                                projects[e.p].hours += (e.h || 0);
                            }
                        }

                        // WEEKLY STATS
                        if (dateStr >= thisWeekStart && dateStr <= thisWeekEnd) {
                            stats.thisWeek.t += (e.h || 0);
                            if (!e.x) stats.thisWeek.t_adj += (e.h || 0);
                            if (e.b) stats.thisWeek.b += (e.h || 0);
                        } 
                        else if (dateStr >= lastWeekStart && dateStr <= lastWeekEnd) {
                            stats.lastWeek.t += (e.h || 0);
                            if (!e.x) stats.lastWeek.t_adj += (e.h || 0);
                            if (e.b) stats.lastWeek.b += (e.h || 0);
                        }
                        
                        processedCount++;
                    } catch (entryError) {
                        console.error(`[PROCESS] Error processing entry ${idx}:`, entryError, e);
                        skippedCount++;
                    }
                });

                console.log(`[PROCESS] Complete. Processed: ${processedCount}, Skipped: ${skippedCount}`);
                console.log('[PROCESS] Final stats:', stats);

                render(stats, users, projects);
                
            } catch (e) {
                console.error('[PROCESS] Fatal error:', e);
                showError('Data Processing Error', `${e.message}\n\n${e.stack || 'No stack trace'}`);
            }
        }

        function render(stats, users, projects) {
            try {
                console.log('[RENDER] Starting render...');
                
                const now = new Date();
                const start = new Date(now.getFullYear(), now.getMonth(), 1);
                let daysPassed = 0;
                let cur = new Date(start);
                
                while(cur <= now) {
                    if(cur.getDay()!==0 && cur.getDay()!==6) daysPassed++;
                    cur.setDate(cur.getDate()+1);
                }
                
                if (now.getHours() < 17) daysPassed = Math.max(daysPassed - 1, 1);
                const totalDays = 20; 
                const projRev = (stats.month.rev / daysPassed) * totalDays;

                console.log('[RENDER] Projection calc:', { daysPassed, totalDays, monthRev: stats.month.rev, projRev });

                safeSetText('month-rev', '$' + Math.round(stats.month.rev || 0).toLocaleString());
                safeSetText('month-proj', '$' + Math.round(projRev || 0).toLocaleString());
                safeSetText('month-total-main', Math.round(stats.month.t || 0) + 'h');

                safeSetText('week-billable', Math.round(stats.thisWeek.b || 0));
                
                const wPct = stats.thisWeek.t_adj > 0 ? Math.round((stats.thisWeek.b / stats.thisWeek.t_adj) * 100) : 0;
                const wPctEl = safeGetElement('week-pct');
                if (wPctEl) {
                    wPctEl.innerText = wPct + '%';
                    wPctEl.className = `text-4xl font-bold mb-1 opacity-60 ${wPct >= 50 ? 'text-green-500' : 'text-red-500'}`;
                }

                safeSetText('last-billable', Math.round(stats.lastWeek.b || 0));
                
                const lPct = stats.lastWeek.t_adj > 0 ? Math.round((stats.lastWeek.b / stats.lastWeek.t_adj) * 100) : 0;
                const lPctEl = safeGetElement('last-pct');
                if (lPctEl) {
                    lPctEl.innerText = lPct + '%';
                    lPctEl.className = `text-3xl font-bold mb-1 opacity-60 ${lPct >= 50 ? 'text-green-500' : 'text-red-500'}`;
                }

                const updatePace = () => {
                    try {
                        const goalInput = safeGetElement('goal-input');
                        const goal = goalInput ? (parseFloat(goalInput.value) || 200) : 200;
                        const billable = stats.thisWeek.b || 0;
                        const pace = Math.round((billable / goal) * 100);
                        const el = safeGetElement('week-pace');
                        if (el) {
                            el.innerText = `Pace: ${pace}%`;
                            if (pace >= 100) el.style.color = "#10b981"; 
                            else if (pace >= 80) el.style.color = "#d97706"; 
                            else el.style.color = "inherit";
                        }
                    } catch (e) {
                        console.error('[RENDER] Pace update error:', e);
                    }
                };
                
                updatePace();
                
                const goalInput = safeGetElement('goal-input');
                if (goalInput) {
                    goalInput.addEventListener('input', updatePace);
                }

                const renderList = (id, listObj) => {
                    try {
                        const el = safeGetElement(id);
                        if (!el) return;
                        
                        el.innerHTML = '';
                        
                        if (!listObj || typeof listObj !== 'object') {
                            console.warn(`[RENDER] Invalid list object for ${id}`);
                            return;
                        }
                        
                        const sorted = Object.keys(listObj).map(k => ({ 
                            name: k, 
                            hours: listObj[k].hours || listObj[k] || 0
                        }));
                        
                        sorted.sort((a,b) => (b.hours || 0) - (a.hours || 0))
                               .slice(0,5)
                               .forEach((item, i) => {
                            el.innerHTML += `
                                <tr class="hover:bg-white hover:bg-opacity-10 dark:border-gray-800">
                                    <td class="px-6 py-3 w-10 text-xs font-mono opacity-50">0${i+1}</td>
                                    <td class="px-6 py-3 font-medium">${item.name || 'Unknown'}</td>
                                    <td class="px-6 py-3 text-right font-mono opacity-80">${Math.round(item.hours || 0)}h</td>
                                </tr>`;
                        });
                    } catch (e) {
                        console.error(`[RENDER] List render error for ${id}:`, e);
                    }
                };
                
                renderList('top-users', users);
                renderList('top-clients', projects);
                
                console.log('[RENDER] Complete');
                
            } catch (e) {
                console.error('[RENDER] Fatal error:', e);
                showError('Rendering Error', `${e.message}\n\n${e.stack || 'No stack trace'}`);
            }
        }
    </script>
</body>
</html>
